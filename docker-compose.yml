version: "3.8"

services:
  server:
    build: ./project
    image: master-image
    container_name: rq-server
    depends_on:
      - redis
    ports:
      - "5000:5000"
    command: gunicorn --workers 4 --bind 0.0.0.0:5000 --timeout 120 'server:create_app()'
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - app-net

  worker:
    image: master-image
    container_name: rq-worker
    depends_on:
      - redis
    command: rq worker --name worker --url redis://redis:6379/0
    restart: unless-stopped
    networks:
      - app-net

  # İstersen bunu açıp ikinci worker ile scale edebilirsin
  # worker2:
  #   image: master-image
  #   container_name: rq-worker2
  #   depends_on:
  #     - redis
  #   command: rq worker --name worker2 --url redis://redis:6379/0
  #   restart: unless-stopped
  #   networks:
  #     - app-net

  dashboard:
    image: master-image
    container_name: rq-dashboard
    depends_on:
      - redis
    ports:
      - "5555:5555"
    command: rq-dashboard --port 5555 --redis-url redis://redis:6379/0
    restart: unless-stopped
    networks:
      - app-net

  redis:
    image: redis:7
    container_name: rq-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - app-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  app-net:
    driver: bridge

volumes:
  redis-data:

